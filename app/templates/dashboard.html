{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid">
    <!-- Hidden app URLs -->
    <div id="app-urls"
         data-upload-url="{{ url_for('main.upload_file') }}"
         data-status-url="{{ url_for('main.get_status_options') }}"
         data-create-section-url="{{ url_for('main.create_section') }}"
         data-get-sections-url="{{ url_for('main.get_sections') }}"
         data-get-stats-url="{{ url_for('main.get_stats') }}"
         style="display: none;">
    </div>

    <!-- Dashboard Header -->
    <div class="dashboard-header-container">
        <div class="dashboard-header">
            <h1><i class="bi bi-speedometer2 me-2"></i>Main Dashboard</h1>
        </div>
        <div class="logout-container">
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary logout-btn">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </a>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
        <div class="action-container">
            <span class="action-title">Action</span>
            <a href="#" class="action-link" id="add-new-file-btn">
                Add New File <i class="bi bi-plus"></i>
            </a>
            <a href="#" class="action-link" id="add-new-section-btn">
                Add New Section <i class="bi bi-folder-plus"></i>
            </a>
            <!-- Moved Quick Stats to action container -->
            <div class="quick-stats-container">
                <div class="stat-item">
                    <div class="stat-icon-wrapper bg-primary">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Files</span>
                        <span class="stat-value" data-stat="files">{{ total_files }}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon-wrapper bg-success">
                        <i class="bi bi-collection"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Sections</span>
                        <span class="stat-value" data-stat="sections">{{ total_sections }}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon-wrapper bg-info">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Last Upload</span>
                        <span class="stat-value" data-stat="last-upload">
                            {{ last_upload.strftime('%m/%d/%Y') if last_upload else 'N/A' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">
                        <i class="bi bi-upload me-2"></i>Upload New File
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="modalUploadForm" action="/upload" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="modalFileInput" class="form-label">Select file to upload</label>
                            <input type="file"
                                   class="form-control"
                                   id="modalFileInput"
                                   name="file"
                                   accept=".csv, .xls, .xlsx"
                                   required>
                            <div class="form-text mt-2">
                                Supported formats: Excel (.xlsx, .xls) or CSV (.csv)
                            </div>
                        </div>
                        <div id="modal-upload-progress-container" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between mb-2">
                                <span id="modal-upload-status">Status: Preparing upload...</span>
                                <span id="modal-upload-percentage">0%</span>
                            </div>
                            <div class="progress">
                                <div id="modal-upload-progress" class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="modal-upload-success-message" class="mt-3 text-success" style="display: none;"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modal-upload-submit">
                        <i class="bi bi-upload me-1"></i>Upload File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Section Modal -->
    <div class="modal fade" id="sectionModal" tabindex="-1" aria-labelledby="sectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sectionModalLabel">
                        <i class="bi bi-folder-plus me-2"></i>Create New Section
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="modalSectionForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="modalSpreadsheetSelect" class="form-label">Select Spreadsheet</label>
                            <select class="form-select" id="modalSpreadsheetSelect" required>
                                <option value="" disabled selected>Choose spreadsheet...</option>
                                {% for spreadsheet in spreadsheets %}
                                    <option value="{{ spreadsheet.id }}">{{ spreadsheet.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalSectionName" class="form-label">Section Name</label>
                            <input type="text" class="form-control" id="modalSectionName"
                                   placeholder="Enter section name" required>
                            <div id="modal-section-name-error" class="invalid-feedback" style="display: none;"></div>
                        </div>
                        <div id="section-success-message" class="mt-3 text-success" style="display: none;"></div>
                        <div id="section-error-message" class="mt-3 text-danger" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modal-section-submit">
                        <span id="section-submit-text">Create Section</span>
                        <span id="section-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Left Sidebar - Replaced with image -->
        <div class="sidebar left-sidebar">
            <img src="{{ url_for('static', filename='images/dashboard2.jpg') }}"
                 alt="Dashboard Visual"
                 class="sidebar-image">
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Section Creation -->
            <div class="sidebar-card">
                <div class="sidebar-card-header">
                    <h2 class="sidebar-title">Here are your Dashboard Sections!</h2>
                </div>
                <div class="sidebar-card-body">
                    <div class="horizontal-section-list">
                        {% include '_sections.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Container -->
    <div class="footer-container">
        <div class="footer-content">
            <!-- Logo Image -->
            <div class="footer-logo">
                <img src="{{ url_for('static', filename='images/dashboard_logo1.png') }}"
                     alt="PepTechnologies Logo"
                     class="logo-image">
            </div>

            <!-- Copyright -->
            <div class="copyright">
                Â© 2025 PepTechnologies, Inc.
            </div>
            <!-- Links as text -->
            <div class="footer-links">
            <span>Terms</span>
            <span>Privacy</span>
            <span>Security</span>
            <span>Contact</span>
            <span>Manage cookies</span>
        </div>
        </div>
    </div>
</div>

<script>
    // Initialize modals
    document.addEventListener('DOMContentLoaded', function() {
        // Get modals
        const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        const sectionModal = new bootstrap.Modal(document.getElementById('sectionModal'));

        // Get buttons
        const addNewFileBtn = document.getElementById('add-new-file-btn');
        const addNewSectionBtn = document.getElementById('add-new-section-btn');
        const modalUploadSubmit = document.getElementById('modal-upload-submit');
        const modalSectionSubmit = document.getElementById('modal-section-submit');

        // File upload functionality
        addNewFileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            uploadModal.show();
        });

        // Section creation functionality
        addNewSectionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Reset form
            document.getElementById('modalSectionForm').reset();
            document.getElementById('section-success-message').style.display = 'none';
            document.getElementById('section-error-message').style.display = 'none';
            sectionModal.show();
        });

        // Handle file upload form submission
        modalUploadSubmit.addEventListener('click', handleFileUpload);

        // Handle section creation form submission
        modalSectionSubmit.addEventListener('click', handleSectionCreation);

        // File upload handler
        function handleFileUpload() {
            const modalFileInput = document.getElementById('modalFileInput');
            const modalUploadForm = document.getElementById('modalUploadForm');

            if (!modalFileInput.value) {
                modalFileInput.click();
                return;
            }

            modalUploadForm.dispatchEvent(new Event('submit'));
        }

        // Section creation handler
        function handleSectionCreation() {
            const spreadsheetSelect = document.getElementById('modalSpreadsheetSelect');
            const sectionNameInput = document.getElementById('modalSectionName');
            const errorMessage = document.getElementById('modal-section-name-error');
            const successMessage = document.getElementById('section-success-message');
            const errorContainer = document.getElementById('section-error-message');
            const submitText = document.getElementById('section-submit-text');
            const spinner = document.getElementById('section-spinner');

            // Reset messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            errorContainer.style.display = 'none';
            sectionNameInput.classList.remove('is-invalid');

            // Validate inputs
            if (!spreadsheetSelect.value) {
                errorContainer.textContent = 'Please select a spreadsheet';
                errorContainer.style.display = 'block';
                return;
            }

            if (!sectionNameInput.value.trim()) {
                errorMessage.textContent = 'Section name is required';
                errorMessage.style.display = 'block';
                sectionNameInput.classList.add('is-invalid');
                return;
            }

            // Show loading state
            submitText.style.display = 'none';
            spinner.style.display = 'inline-block';
            modalSectionSubmit.disabled = true;

            // Prepare data
            const formData = new FormData();
            formData.append('spreadsheet_id', spreadsheetSelect.value);
            formData.append('name', sectionNameInput.value.trim());
            formData.append('csrf_token', '{{ csrf_token() }}');

            // Get create section URL from hidden element
            const createSectionUrl = document.getElementById('app-urls').dataset.createSectionUrl;

            // Send request
            fetch(createSectionUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    successMessage.textContent = 'Section created successfully!';
                    successMessage.style.display = 'block';

                    // Close modal after 1.5 seconds
                    setTimeout(() => {
                        sectionModal.hide();
                        // Reload page to show new section
                        setTimeout(() => location.reload(), 500);
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Failed to create section');
                }
            })
            .catch(error => {
                errorContainer.textContent = error.message || 'An error occurred while creating the section';
                errorContainer.style.display = 'block';
            })
            .finally(() => {
                // Reset button state
                submitText.style.display = 'inline';
                spinner.style.display = 'none';
                modalSectionSubmit.disabled = false;
            });
        }

        // File upload form submission handler
        const modalUploadForm = document.getElementById('modalUploadForm');
        modalUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Show progress container
            document.getElementById('modal-upload-progress-container').style.display = 'block';

            // Create FormData object
            const formData = new FormData(this);

            // AJAX request to upload file
            const xhr = new XMLHttpRequest();

            // Progress update
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    document.getElementById('modal-upload-progress').style.width = percentComplete + '%';
                    document.getElementById('modal-upload-percentage').textContent = Math.round(percentComplete) + '%';
                    document.getElementById('modal-upload-status').textContent = 'Status: Uploading...';
                }
            });

            // Load complete
            xhr.addEventListener('load', function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    // Success
                    document.getElementById('modal-upload-status').textContent = 'Status: Upload complete!';
                    document.getElementById('modal-upload-success-message').textContent =
                        'File uploaded successfully! Processing...';
                    document.getElementById('modal-upload-success-message').style.display = 'block';

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        uploadModal.hide();
                        // Reload page after a delay to show new file
                        setTimeout(() => location.reload(), 1000);
                    }, 2000);
                } else {
                    // Error
                    document.getElementById('modal-upload-status').textContent =
                        'Error: ' + (xhr.responseText || 'Upload failed');
                }
            });

            // Error handling
            xhr.addEventListener('error', function() {
                document.getElementById('modal-upload-status').textContent = 'Error: Upload failed';
            });

            // Send request
            xhr.open('POST', this.action, true);
            xhr.send(formData);
        });

        // Reset upload modal when closed
        document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
            modalUploadForm.reset();
            document.getElementById('modal-upload-progress-container').style.display = 'none';
            document.getElementById('modal-upload-progress').style.width = '0%';
            document.getElementById('modal-upload-percentage').textContent = '0%';
            document.getElementById('modal-upload-status').textContent = 'Status: Preparing upload...';
            document.getElementById('modal-upload-success-message').style.display = 'none';
        });

        // Reset section modal when closed
        document.getElementById('sectionModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('modalSectionForm').reset();
            document.getElementById('modal-section-name-error').style.display = 'none';
            document.getElementById('section-success-message').style.display = 'none';
            document.getElementById('section-error-message').style.display = 'none';
            document.getElementById('modalSectionName').classList.remove('is-invalid');

            // Reset button state
            document.getElementById('section-submit-text').style.display = 'inline';
            document.getElementById('section-spinner').style.display = 'none';
            document.getElementById('modal-section-submit').disabled = false;
        });

        // Get CSRF token dynamically
    const csrfToken = document.querySelector('#modalSectionForm input[name="csrf_token"]').value;

    // Use URLSearchParams instead of FormData
    const params = new URLSearchParams();
    params.append('spreadsheet_id', spreadsheetSelect.value);
    params.append('section_name', sectionNameInput.value.trim());
    params.append('csrf_token', csrfToken);

    fetch(createSectionUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params
    })

    });
</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    :root {
        --sidebar-width: 30%;
        --main-width: 40%;
        --gap-size: 20px;
    }

    body {
        font-family: 'Inter', sans-serif;
        line-height: 1.6;
        padding-top: 80px; /* Add padding to body for fixed header */
    }

    .dashboard-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #F0FFFF;
        padding: 15px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        height: 60px; /* Fixed height for header */
    }

    .dashboard-layout {
        margin-top: 0; /* Removed margin-top since body has padding */
    }

    .dashboard-header h1 {
        font-size: 1.0rem;
        font-weight: 600;
        margin: 0;
        color: #2c3e50;
        font-family: 'Inter', sans-serif;
    }

    .logout-btn {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }

    .dashboard-layout {
        display: grid;
        grid-template-columns: var(--sidebar-width) var(--main-width) var(--sidebar-width);
        gap: var(--gap-size);
        width: 100%;
    }

    .sidebar {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
    }

    /* Left sidebar image styling */
    .left-sidebar {
        padding: 0;
        display: flex;
    }

    .sidebar-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }

    .sidebar-card {
        margin-bottom: 1.5rem;
    }

    .sidebar-card-header {
        margin-bottom: 1rem;
    }

    .sidebar-title {
        font-size: 1.6rem;
        font-weight: 500;
        color: #34495e;
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        font-family: 'Inter', sans-serif;
    }

    .horizontal-section-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding: 0;
    }

    .section-pill {
        display: inline-block;
        padding: 8px 12px;
        background: #1677FF;
        border-radius: 20px;
        color: #FFFFFF;
        text-decoration: none;
        font-size: 12px;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        margin: 2px;
    }

    .main-content {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
    }

    .form-card {
        margin-bottom: 1.5rem;
    }

    .card-header h3 {
        font-size: 24px;
        font-weight: 500;
        color: #34495e;
        display: flex;
        align-items: center;
    }

    .form-label {
        font-weight: 500;
        color: #334155;
        margin-bottom: 0.5rem;
        font-size: 18px;
        font-family: 'Inter', sans-serif;
    }

    .form-control, .form-select {
        padding: 0.6rem 0.75rem;
        font-size: 18px;
    }

    #upload-success-message {
        font-weight: 500;
        font-size: 1.1rem;
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Action Bar Styles - FIXED POSITIONING */
    .action-bar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.8rem 1.5rem;
        top: 60px; /* Below the header */
        left: 0;
        right: 0;
        z-index: 999; /* Below header but above content */
        display: flex;
        justify-content: center;
    }

    .action-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        max-width: 1400px;
        width: 100%;
        margin: 0 auto;
    }

    .action-title {
        font-weight: 600;
        font-size: 0.8rem;
        color: #495057;
        margin-right: 1.5rem;
        font-family: 'Inter', sans-serif;
        white-space: nowrap;
    }

    .action-link {
        display: flex;
        align-items: center;
        color: #0d6efd;
        text-decoration: none;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-family: 'Inter', sans-serif;
        white-space: nowrap;
    }

    .action-link:hover {
        background-color: #e9ecef;
        text-decoration: none;
        color: #0a58ca;
    }

    .action-link i {
        margin-left: 0.4rem;
        font-size: 0.8rem;
    }

    /* Quick Stats Container in Action Bar */
    .quick-stats-container {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-left: auto; /* Push to the right end */
        padding: 0 10px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #ffffff;
        border-radius: 8px;
        padding: 8px 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .stat-icon-wrapper {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        letter-spacing: 0.5px;
        font-family: 'Inter', sans-serif;
        white-space: nowrap;
    }

    .stat-value {
        font-size: 0.8rem;
        font-weight: 700;
        color: #1e293b;
    }

    .bg-primary { background: #3b82f6; }
    .bg-success { background: #10b981; }
    .bg-info { background: #06b6d4; }

    /* Modal adjustments */
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-title {
        font-weight: 500;
    }

    .modal-footer {
        border-top: 1px solid #dee2e6;
    }

    /* Section modal specific styles */
    #section-spinner {
        margin-left: 8px;
        vertical-align: middle;
    }

    /* Section creation form in main content */
    .section-creation-container {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
    }

    .section-creation-container .card-header {
        background: linear-gradient(135deg, #6c5ce7, #a8a4e6);
        color: white;
        border-radius: 8px 8px 0 0;
    }

    .invalid-feedback {
        display: none;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }

  /* Footer styles - Horizontal layout */
    .footer-container {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 20px 0;
        margin-top: 40px;
    }

    .footer-content {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: center;
        justify-content: center;
        max-width: 1200px;
        margin: 0 auto;
        gap: 30px;
    }

    .footer-logo {
        display: flex;
        align-items: center;
        margin: 0;
    }

    .logo-image {
        height: 30px;
        width: auto;
    }

    .copyright {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 0;
        white-space: nowrap;
    }

    .footer-links {
        display: flex;
        flex-wrap: nowrap;
        gap: 20px;
    }

    .footer-links span {
        color: #495057;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    /* Responsive adjustments for footer */
    @media (max-width: 1200px) {
        .footer-content {
            gap: 20px;
        }

        .footer-links {
            gap: 15px;
        }
    }

    @media (max-width: 992px) {
        .footer-content {
            gap: 15px;
        }

        .footer-links {
            gap: 12px;
        }

        .logo-image {
            height: 25px;
        }

        .copyright, .footer-links span {
            font-size: 0.85rem;
        }
    }

    @media (max-width: 768px) {
        .footer-content {
            gap: 12px;
            padding: 0 15px;
        }

        .footer-links {
            gap: 10px;
        }

        .logo-image {
            height: 22px;
        }

        .copyright, .footer-links span {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 576px) {
        .footer-content {
            gap: 8px;
            padding: 0 10px;
        }

        .footer-links {
            gap: 8px;
        }

        .logo-image {
            height: 20px;
        }

        .copyright, .footer-links span {
            font-size: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .footer-content {
            gap: 6px;
            padding: 0 5px;
        }

        .footer-links {
            gap: 6px;
        }

        .copyright, .footer-links span {
            font-size: 0.7rem;
        }
    }

</style>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}